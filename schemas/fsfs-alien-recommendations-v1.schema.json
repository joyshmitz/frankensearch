{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://frankensearch.dev/schemas/fsfs-alien-recommendations-v1.schema.json",
  "title": "fsfs Alien Recommendation Contracts v1",
  "oneOf": [
    {
      "$ref": "#/$defs/recommendationCard"
    },
    {
      "$ref": "#/$defs/recommendationBundle"
    }
  ],
  "$defs": {
    "subsystem": {
      "type": "string",
      "enum": [
        "ingestion_policy",
        "degradation_scheduler",
        "ranking_policy"
      ]
    },
    "reasonCode": {
      "type": "string",
      "pattern": "^FSFS_[A-Z0-9_]+$"
    },
    "cardCore": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "subsystem",
        "ev_score",
        "priority_tier",
        "adoption_wedge",
        "budgeted_mode",
        "fallback_trigger",
        "baseline_comparator",
        "isomorphism_proof_plan",
        "repro_artifacts",
        "rollback_plan"
      ],
      "properties": {
        "subsystem": {
          "$ref": "#/$defs/subsystem"
        },
        "ev_score": {
          "type": "number",
          "minimum": 0
        },
        "priority_tier": {
          "type": "string",
          "enum": [
            "A",
            "B",
            "C"
          ]
        },
        "adoption_wedge": {
          "type": "string",
          "minLength": 8
        },
        "budgeted_mode": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "latency_budget_ms",
            "memory_budget_mb",
            "retry_budget",
            "on_exhaustion"
          ],
          "properties": {
            "latency_budget_ms": {
              "type": "integer",
              "minimum": 1
            },
            "memory_budget_mb": {
              "type": "integer",
              "minimum": 1
            },
            "retry_budget": {
              "type": "integer",
              "minimum": 0
            },
            "on_exhaustion": {
              "type": "string",
              "minLength": 8
            }
          }
        },
        "fallback_trigger": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "condition",
            "fallback_action",
            "reason_code"
          ],
          "properties": {
            "condition": {
              "type": "string",
              "minLength": 3
            },
            "fallback_action": {
              "type": "string",
              "minLength": 3
            },
            "reason_code": {
              "$ref": "#/$defs/reasonCode"
            }
          }
        },
        "baseline_comparator": {
          "type": "string",
          "minLength": 8
        },
        "isomorphism_proof_plan": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "invariants",
            "baseline_harness",
            "replay_checks"
          ],
          "properties": {
            "invariants": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "string",
                "minLength": 5
              }
            },
            "baseline_harness": {
              "type": "string",
              "minLength": 5
            },
            "replay_checks": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "string",
                "minLength": 5
              }
            }
          }
        },
        "repro_artifacts": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "manifest_fields",
            "artifact_outputs",
            "replay_command"
          ],
          "properties": {
            "manifest_fields": {
              "type": "array",
              "minItems": 3,
              "items": {
                "type": "string",
                "enum": [
                  "seed",
                  "config_hash",
                  "subsystem",
                  "policy_version",
                  "scenario_id"
                ]
              },
              "allOf": [
                {
                  "contains": {
                    "const": "seed"
                  }
                },
                {
                  "contains": {
                    "const": "config_hash"
                  }
                },
                {
                  "contains": {
                    "const": "subsystem"
                  }
                }
              ]
            },
            "artifact_outputs": {
              "type": "array",
              "minItems": 2,
              "items": {
                "type": "string",
                "minLength": 3
              }
            },
            "replay_command": {
              "type": "string",
              "minLength": 8
            }
          }
        },
        "rollback_plan": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "rollback_command",
            "abort_conditions"
          ],
          "properties": {
            "rollback_command": {
              "type": "string",
              "minLength": 8
            },
            "abort_conditions": {
              "type": "array",
              "minItems": 1,
              "items": {
                "type": "string",
                "minLength": 5
              }
            }
          }
        }
      }
    },
    "recommendationCard": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "kind",
        "v",
        "subsystem",
        "ev_score",
        "priority_tier",
        "adoption_wedge",
        "budgeted_mode",
        "fallback_trigger",
        "baseline_comparator",
        "isomorphism_proof_plan",
        "repro_artifacts",
        "rollback_plan"
      ],
      "properties": {
        "kind": {
          "type": "string",
          "const": "fsfs_alien_recommendation_card"
        },
        "v": {
          "type": "integer",
          "const": 1
        },
        "subsystem": {
          "$ref": "#/$defs/subsystem"
        },
        "ev_score": {
          "type": "number",
          "minimum": 0
        },
        "priority_tier": {
          "type": "string",
          "enum": [
            "A",
            "B",
            "C"
          ]
        },
        "adoption_wedge": {
          "type": "string",
          "minLength": 8
        },
        "budgeted_mode": {
          "$ref": "#/$defs/cardCore/properties/budgeted_mode"
        },
        "fallback_trigger": {
          "$ref": "#/$defs/cardCore/properties/fallback_trigger"
        },
        "baseline_comparator": {
          "type": "string",
          "minLength": 8
        },
        "isomorphism_proof_plan": {
          "$ref": "#/$defs/cardCore/properties/isomorphism_proof_plan"
        },
        "repro_artifacts": {
          "$ref": "#/$defs/cardCore/properties/repro_artifacts"
        },
        "rollback_plan": {
          "$ref": "#/$defs/cardCore/properties/rollback_plan"
        }
      }
    },
    "recommendationBundle": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "kind",
        "v",
        "cards"
      ],
      "properties": {
        "kind": {
          "type": "string",
          "const": "fsfs_alien_recommendation_bundle"
        },
        "v": {
          "type": "integer",
          "const": 1
        },
        "cards": {
          "type": "array",
          "minItems": 3,
          "items": {
            "$ref": "#/$defs/recommendationCard"
          },
          "allOf": [
            {
              "contains": {
                "type": "object",
                "properties": {
                  "subsystem": {
                    "const": "ingestion_policy"
                  }
                },
                "required": [
                  "subsystem"
                ]
              }
            },
            {
              "contains": {
                "type": "object",
                "properties": {
                  "subsystem": {
                    "const": "degradation_scheduler"
                  }
                },
                "required": [
                  "subsystem"
                ]
              }
            },
            {
              "contains": {
                "type": "object",
                "properties": {
                  "subsystem": {
                    "const": "ranking_policy"
                  }
                },
                "required": [
                  "subsystem"
                ]
              }
            }
          ]
        }
      }
    }
  }
}
