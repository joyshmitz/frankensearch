{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://frankensearch.dev/schemas/telemetry-transport-v1.schema.json",
  "title": "frankensearch Telemetry Transport Contract v1",
  "oneOf": [
    {
      "$ref": "#/$defs/contractDefinition"
    },
    {
      "$ref": "#/$defs/transportEndpoint"
    },
    {
      "$ref": "#/$defs/subscribeFrame"
    },
    {
      "$ref": "#/$defs/streamFrame"
    }
  ],
  "$defs": {
    "ulid": {
      "type": "string",
      "pattern": "^[0-9A-HJKMNP-TV-Z]{26}$"
    },
    "topic": {
      "type": "string",
      "enum": [
        "search",
        "embedding",
        "index",
        "resource",
        "anomaly",
        "lifecycle"
      ]
    },
    "contractDefinition": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "kind",
        "v",
        "primary_transport",
        "fallback_transport",
        "backpressure",
        "lifecycle",
        "multi_consumer",
        "security",
        "slo_targets"
      ],
      "properties": {
        "kind": {
          "type": "string",
          "const": "telemetry_transport_contract_definition"
        },
        "v": {
          "type": "integer",
          "const": 1
        },
        "primary_transport": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "type",
            "socket_path_template",
            "framing",
            "supported_codecs",
            "auth_mode"
          ],
          "properties": {
            "type": {
              "type": "string",
              "const": "unix_domain_socket"
            },
            "socket_path_template": {
              "type": "string",
              "const": "${XDG_RUNTIME_DIR}/frankensearch/{instance_id}.sock"
            },
            "framing": {
              "type": "string",
              "const": "length_prefixed"
            },
            "supported_codecs": {
              "type": "array",
              "uniqueItems": true,
              "minItems": 2,
              "items": {
                "type": "string",
                "enum": [
                  "msgpack",
                  "cbor"
                ]
              },
              "allOf": [
                {
                  "contains": {
                    "const": "msgpack"
                  }
                },
                {
                  "contains": {
                    "const": "cbor"
                  }
                }
              ]
            },
            "auth_mode": {
              "type": "string",
              "const": "uid_match"
            }
          }
        },
        "fallback_transport": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "type",
            "path_template"
          ],
          "properties": {
            "type": {
              "type": "string",
              "const": "jsonl_file"
            },
            "path_template": {
              "type": "string",
              "const": "{data_dir}/telemetry/{instance_id}.jsonl"
            }
          }
        },
        "backpressure": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "strategy",
            "drop_counter_required",
            "max_inflight_min",
            "block_instance_search"
          ],
          "properties": {
            "strategy": {
              "type": "string",
              "const": "drop_not_block"
            },
            "drop_counter_required": {
              "type": "boolean",
              "const": true
            },
            "max_inflight_min": {
              "type": "integer",
              "minimum": 1
            },
            "block_instance_search": {
              "type": "boolean",
              "const": false
            }
          }
        },
        "lifecycle": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "handshake_required",
            "heartbeat_required",
            "resume_required",
            "disconnect_behavior"
          ],
          "properties": {
            "handshake_required": {
              "type": "boolean",
              "const": true
            },
            "heartbeat_required": {
              "type": "boolean",
              "const": true
            },
            "resume_required": {
              "type": "boolean",
              "const": true
            },
            "disconnect_behavior": {
              "type": "string",
              "const": "graceful_or_retry"
            }
          }
        },
        "multi_consumer": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "mode",
            "max_consumers"
          ],
          "properties": {
            "mode": {
              "type": "string",
              "const": "fan_out"
            },
            "max_consumers": {
              "type": "integer",
              "minimum": 1
            }
          }
        },
        "security": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "local_only",
            "network_transport_allowed"
          ],
          "properties": {
            "local_only": {
              "type": "boolean",
              "const": true
            },
            "network_transport_allowed": {
              "type": "boolean",
              "const": false
            }
          }
        },
        "slo_targets": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "p95_delivery_lag_ms_target",
            "throughput_eps_target"
          ],
          "properties": {
            "p95_delivery_lag_ms_target": {
              "type": "number",
              "minimum": 0,
              "maximum": 100
            },
            "throughput_eps_target": {
              "type": "integer",
              "minimum": 10000
            }
          }
        }
      }
    },
    "transportEndpoint": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "kind",
        "v",
        "instance_id",
        "project_key",
        "socket_path",
        "fallback_jsonl_path",
        "framing",
        "codec",
        "auth_mode",
        "heartbeat_ms",
        "max_inflight",
        "drop_policy"
      ],
      "properties": {
        "kind": {
          "type": "string",
          "const": "telemetry_transport_endpoint"
        },
        "v": {
          "type": "integer",
          "const": 1
        },
        "instance_id": {
          "$ref": "#/$defs/ulid"
        },
        "project_key": {
          "type": "string",
          "minLength": 1
        },
        "socket_path": {
          "type": "string",
          "pattern": "^/.+\\.sock$"
        },
        "fallback_jsonl_path": {
          "type": "string",
          "pattern": "^/.+\\.jsonl$"
        },
        "framing": {
          "type": "string",
          "const": "length_prefixed"
        },
        "codec": {
          "type": "string",
          "enum": [
            "msgpack",
            "cbor"
          ]
        },
        "auth_mode": {
          "type": "string",
          "const": "uid_match"
        },
        "heartbeat_ms": {
          "type": "integer",
          "minimum": 100,
          "maximum": 10000
        },
        "max_inflight": {
          "type": "integer",
          "minimum": 1
        },
        "drop_policy": {
          "type": "string",
          "const": "drop_not_block"
        }
      }
    },
    "subscribeFrame": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "kind",
        "v",
        "connection_id",
        "instance_id",
        "topic_filter",
        "resume_cursor",
        "heartbeat_ms",
        "max_inflight"
      ],
      "properties": {
        "kind": {
          "type": "string",
          "const": "telemetry_transport_subscribe"
        },
        "v": {
          "type": "integer",
          "const": 1
        },
        "connection_id": {
          "$ref": "#/$defs/ulid"
        },
        "instance_id": {
          "$ref": "#/$defs/ulid"
        },
        "topic_filter": {
          "type": "array",
          "minItems": 1,
          "uniqueItems": true,
          "items": {
            "$ref": "#/$defs/topic"
          }
        },
        "resume_cursor": {
          "type": [
            "string",
            "null"
          ]
        },
        "heartbeat_ms": {
          "type": "integer",
          "minimum": 100,
          "maximum": 10000
        },
        "max_inflight": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "streamFrame": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "kind",
        "v",
        "frame_type",
        "transport",
        "connection_id",
        "sequence",
        "producer_ts",
        "dispatch_ts",
        "lag_ms",
        "dropped_since_last",
        "payload"
      ],
      "properties": {
        "kind": {
          "type": "string",
          "const": "telemetry_transport_stream_frame"
        },
        "v": {
          "type": "integer",
          "const": 1
        },
        "frame_type": {
          "type": "string",
          "enum": [
            "event",
            "control",
            "heartbeat",
            "error"
          ]
        },
        "transport": {
          "type": "string",
          "enum": [
            "unix_domain_socket",
            "jsonl_fallback"
          ]
        },
        "connection_id": {
          "$ref": "#/$defs/ulid"
        },
        "sequence": {
          "type": "integer",
          "minimum": 0
        },
        "producer_ts": {
          "type": "string",
          "format": "date-time"
        },
        "dispatch_ts": {
          "type": "string",
          "format": "date-time"
        },
        "lag_ms": {
          "type": "number",
          "minimum": 0
        },
        "dropped_since_last": {
          "type": "integer",
          "minimum": 0
        },
        "payload": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "cursor": {
              "type": "string",
              "minLength": 1
            },
            "event_id": {
              "$ref": "#/$defs/ulid"
            },
            "topic": {
              "$ref": "#/$defs/topic"
            },
            "bytes": {
              "type": "integer",
              "minimum": 0
            },
            "encoding": {
              "type": "string",
              "enum": [
                "msgpack",
                "cbor",
                "json"
              ]
            },
            "control_type": {
              "type": "string",
              "enum": [
                "backpressure",
                "reconnect_advisory"
              ]
            },
            "reason_code": {
              "type": "string",
              "minLength": 1
            },
            "heartbeat_seq": {
              "type": "integer",
              "minimum": 0
            },
            "error_code": {
              "type": "string",
              "minLength": 1
            },
            "retry_after_ms": {
              "type": "integer",
              "minimum": 0
            }
          }
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "frame_type": {
                "const": "event"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "required": [
                  "cursor",
                  "event_id",
                  "topic",
                  "bytes",
                  "encoding"
                ]
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "frame_type": {
                "const": "control"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "required": [
                  "control_type",
                  "reason_code"
                ]
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "frame_type": {
                "const": "heartbeat"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "required": [
                  "heartbeat_seq"
                ]
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "frame_type": {
                "const": "error"
              }
            }
          },
          "then": {
            "properties": {
              "payload": {
                "required": [
                  "error_code",
                  "reason_code",
                  "retry_after_ms"
                ]
              }
            }
          }
        }
      ]
    }
  }
}
